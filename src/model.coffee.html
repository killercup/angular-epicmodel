<!doctype html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Epic Model - model.coffee</title>

  <link rel="stylesheet" href="../assets/style.css">

  <meta name="viewport" content="width=device-width, initial-scale=1.0, minimum-scale=1.0, maximum-scale=1.0"/>
  <meta name="groc-relative-root" content="../"/>
  <meta name="groc-document-path" content="src/model.coffee"/>
  
  <meta name="groc-repository-url" content="https://github.com/killercup/angular-epicmodel"/>
  
</head>
<body>
  <div id="file-area">
    <div id="meta">
      <code class="file-path">
      
        <a href="https://github.com/killercup/angular-epicmodel/blob/master/src/model.coffee">src/model.coffee</a>
      
      </code>
    </div>
    <div id="document">
    
      <div class="segment">
      
        <div class="comments ">
          <div class="wrapper"><h1 id="epic-model"><a href="#epic-model" class="anchor"></a>Epic Model</h1></div>
        </div>
      
      
        <div class="code"><div class="wrapper">angular.<span class="hljs-built_in">module</span>(<span class="hljs-string">'EpicModel'</span>, [
])

.provider <span class="hljs-string">"Collection"</span>,<span class="hljs-function"> -&gt;</span></div></div>
      
      </div>
    
      <div class="segment">
      
        <div class="comments doc-section">
          <div class="wrapper"><p>Create your own collection by injecting the <code>Collection</code> service and calling
its &#39;new&#39; method.</p>
<p>Example:</p>
<pre><code class="lang-coffeescript">angular.<span class="hljs-built_in">module</span>(<span class="hljs-string">'Module'</span>, [<span class="hljs-string">'EpicModel'</span>])
.factory <span class="hljs-string">"API"</span>, <span class="hljs-function"><span class="hljs-params">(Collection)</span> -&gt;</span>
    API =
      <span class="hljs-attribute">People</span>: Collection.<span class="hljs-keyword">new</span> <span class="hljs-string">'People'</span>, {<span class="hljs-attribute">url</span>: <span class="hljs-string">'/people/:id'</span>},
        <span class="hljs-attribute">calculateStuff</span>: <span class="hljs-function"><span class="hljs-params">(input)</span> -&gt;</span> <span class="hljs-number">42</span>
.controller <span class="hljs-string">"Ctrl"</span>, <span class="hljs-function"><span class="hljs-params">($scope, ShittyAPI)</span> -&gt;</span>
    $scope.list = API.People.all()
</code></pre>
<p><strong>Immediate Return Data</strong></p>
<p>Most methods return a promise, but the methods <code>all</code> and <code>get</code> methods
return a special object instead, that contains the currently available data,
a promise and flags to represent the data retrieval state. I.e., you can
immediately use the return value in your views and the data will
automatically appear once it has been retrieved (or updated).</p>
<p>Example:</p>
<pre><code class="lang-coffeescript">Me = Collection.<span class="hljs-keyword">new</span> <span class="hljs-string">"Me"</span>, <span class="hljs-attribute">is_singleton</span>: <span class="hljs-literal">true</span>
Me.all()
<span class="hljs-comment">#=&gt; {data: {}, $resolved: false, $loading: true, $promise: {then, ...}}</span>
</code></pre>
</div>
        </div>
      
      
      </div>
    
      <div class="segment">
      
        <div class="comments doc-section">
          <div class="wrapper"><h2 id="global-config"><a href="#global-config" class="anchor"></a>Global Config</h2><p>Just inject the <code>CollectionProvider</code> and set some globals.</p>
<p>Example:</p>
<pre><code class="lang-coffeescript">angular.<span class="hljs-built_in">module</span>(<span class="hljs-string">'app'</span>, [<span class="hljs-string">'EpicModel'</span>])
.config <span class="hljs-function"><span class="hljs-params">(CollectionProvider)</span> -&gt;</span>
    CollectionProvider.setBaseUrl(<span class="hljs-string">'http://example.com/api/v1'</span>)
</code></pre>
</div>
        </div>
      
      
        <div class="code"><div class="wrapper">  globalConfig =
    <span class="hljs-attribute">baseUrl</span>: <span class="hljs-string">''</span>
</div></div>
      
      </div>
    
      <div class="segment">
      
        <div class="comments doc-section">
          <div class="wrapper"><p><span class='doc-section-header'>Method: <code>Set Base URL</code></span></p>
<p>Parameters:</p>
<ul>
<li><strong><code>url</code> must be a String.</strong><br/>(The new base URL)</li>
</ul>
<p><strong>Returns a String</strong><br/>(The new base URL)<br/><strong>and</strong> <strong>Can throw an Error</strong><br/>(When no URL is given)</p>
</div>
        </div>
      
      
        <div class="code"><div class="wrapper">  <span class="hljs-property">@setBaseUrl</span> = <span class="hljs-function"><span class="hljs-params">(url=<span class="hljs-string">''</span>)</span> -&gt;</span>
    <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> Error <span class="hljs-string">"No URL given."</span> <span class="hljs-keyword">unless</span> url?
    globalConfig.baseUrl = url
</div></div>
      
      </div>
    
      <div class="segment">
      
        <div class="comments ">
          <div class="wrapper"><hr>
<p>The service factory function</p>
</div>
        </div>
      
      
        <div class="code"><div class="wrapper">  <span class="hljs-property">@$get</span> = <span class="hljs-function"><span class="hljs-params">($q, $http)</span> -&gt;</span></div></div>
      
      </div>
    
      <div class="segment">
      
        <div class="comments doc-section">
          <div class="wrapper"><h2 id="constructor"><a href="#constructor" class="anchor"></a>Constructor</h2><p>Create a new Collection.</p>
<p>Parameters:</p>
<ul>
<li><strong><code>name</code> must be a String.</strong><br/>(The unique name of the new collection.)</li>
<li><strong><code>config</code> is optional and must be an Object.</strong><br/>(Configuration and settings)<ul>
<li><strong><code>config.url</code> is optional and can be a String or a Function.</strong><br/>(Resource URL)</li>
<li><strong><code>config.detailUrl</code> is optional and can be a String or a Function.</strong><br/>(URL for single resource, default: <code>config.url + &#39;/&#39; + entry.id</code>. Will interpolate segments in curly brackets, e.g. transforming <code>/item/{_id}</code> to <code>&#39;/item/&#39;+entry._id</code>. If you supply a function, it will be called with the current entry, the base URL and the resource list url (<code>config.url</code>) and should return a string that will be used as URL.)</li>
<li><strong><code>config.baseUrl</code> is optional and must be a String.</strong><br/>(Overwrite base URL)</li>
<li><strong><code>config.is_singleton</code> is optional and must be a Bool.</strong><br/>(Whether resource returns an object)</li>
<li><strong><code>config.storage</code> is optional and must be an Object.</strong><br/>(Storage implementation, e.g. <code>CollectionLocalStorage</code> (see below))</li>
<li><strong><code>config.storage.setItem</code> is optional and must be a Function.</strong></li>
<li><strong><code>config.storage.getItem</code> is optional and must be a Function.</strong></li>
<li><strong><code>config.storage.removeItem</code> is optional and must be a Function.</strong></li>
<li><strong><code>config.transformRequest</code> is optional, must be a Function, and has a default value of <code>_.identity</code>.</strong><br/>(Takes the <em>request</em> <code>data</code> and a hint like &#39;array&#39;, &#39;one&#39;, &#39;save&#39;, &#39;destroy&#39; and returns the transformed <code>data</code>. <em>NYI</em>)</li>
<li><strong><code>config.transformResponse</code> is optional, must be a Function, and has a default value of <code>_.identity</code>.</strong><br/>(Takes the <em>response</em> <code>data</code> and a hint like &#39;array&#39;, &#39;one&#39;, &#39;save&#39;, &#39;destroy&#39; and returns the transformed <code>data</code>.)</li>
<li><strong><code>config.matchingCriteria</code> is optional and must be a Function.</strong><br/>(Takes data object and returns matching criteria. Default: <code>(data) -&gt; id: +data.id</code>)</li>
</ul>
</li>
<li><strong><code>extras</code> is optional and must be an Object.</strong><br/>(Add custom methods to instance, functions will be have <code>config</code> as <code>this</code>, objects will used to construct new <code>$http</code> calls)</li>
</ul>
<p><strong>Returns an Object</strong><br/>(The collection)<br/><strong>and</strong> <strong>Can throw an Error</strong><br/>(When no name is given)</p>
<p>Example:</p>
<pre><code class="lang-coffeescript">Collection.<span class="hljs-keyword">new</span> <span class="hljs-string">'User'</span>, {
    <span class="hljs-attribute">url</span>: <span class="hljs-string">'/user'</span> <span class="hljs-comment"># also set implicitly from name</span>
    <span class="hljs-attribute">is_singleton</span>: <span class="hljs-literal">true</span> <span class="hljs-comment"># Expect single object instead of array</span>
    <span class="hljs-attribute">storage</span>: myStorage <span class="hljs-comment"># see below</span>
}, {
    <span class="hljs-attribute">something</span>: <span class="hljs-function"><span class="hljs-params">(id)</span> -&gt;</span> <span class="hljs-number">42</span>
    <span class="hljs-attribute">pay</span>:
      <span class="hljs-attribute">method</span>: <span class="hljs-string">'PATCH'</span>
      <span class="hljs-attribute">params</span>:
        <span class="hljs-attribute">payout</span>: <span class="hljs-literal">true</span>
}
</code></pre>
</div>
        </div>
      
      
        <div class="code"><div class="wrapper">    <span class="hljs-function"><span class="hljs-title">constructor</span> = <span class="hljs-params">(name, config={}, extras={})</span> -&gt;</span></div></div>
      
      </div>
    
      <div class="segment">
      
        <div class="comments ">
          <div class="wrapper"><p>This will be returned.</p>
</div>
        </div>
      
      
        <div class="code"><div class="wrapper">      <span class="hljs-built_in">exports</span> = {}
</div></div>
      
      </div>
    
      <div class="segment">
      
        <div class="comments ">
          <div class="wrapper"><h3 id="options"><a href="#options" class="anchor"></a>Options</h3></div>
        </div>
      
      
        <div class="code"><div class="wrapper">      <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> Error <span class="hljs-string">"No name given!"</span> <span class="hljs-keyword">unless</span> name?
</div></div>
      
      </div>
    
      <div class="segment">
      
        <div class="comments doc-section">
          <div class="wrapper"><p><span class='doc-section-header'>Method: <code>Config Getter</code></span></p>
<p>Retrieve config value from instance</p>
<p>Parameters:</p>
<ul>
<li><strong><code>key</code> must be a String.</strong></li>
</ul>
<p><strong>Returns an Any</strong><br/>(Config value)</p>
</div>
        </div>
      
      
        <div class="code"><div class="wrapper">      <span class="hljs-built_in">exports</span>.<span class="hljs-function"><span class="hljs-title">config</span> = <span class="hljs-params">(key)</span> -&gt;</span>
        config[key]

      config.url ||= <span class="hljs-string">'/'</span> + name.toLowerCase()
      config.baseUrl ||= globalConfig.baseUrl
      config.listUrl ||= config.url
</div></div>
      
      </div>
    
      <div class="segment">
      
        <div class="comments doc-section">
          <div class="wrapper"><p><span class='doc-section-header'>Method: <code>Make Detail URL from Pattern</code></span></p>
<p>Parameters:</p>
<ul>
<li><strong><code>entry</code> must be an Object.</strong><br/>(The entry to URL points to)</li>
<li><strong><code>listUrl</code> is optional, must be a String, and has a default value of config.url.</strong></li>
<li><strong><code>baseUrl</code> is optional, must be a String, and has a default value of config.baseUrl.</strong></li>
</ul>
<p><strong>Returns a String</strong><br/>(Entry URL)</p>
</div>
        </div>
      
      
        <div class="code"><div class="wrapper">      config.<span class="hljs-function"><span class="hljs-title">parseUrlPattern</span> = <span class="hljs-params">(entry, url)</span> -&gt;</span>
        substitutes = <span class="hljs-regexp">/\{([\w_.]*?)\}/g</span>
        entryUrl = url
        _.each url.match<span class="hljs-function"><span class="hljs-params">(substitutes)</span>, <span class="hljs-params">(match)</span> -&gt;</span></div></div>
      
      </div>
    
      <div class="segment">
      
        <div class="comments ">
          <div class="wrapper"><p>Remove braces and split on dots (might address sub-object, e.g.
using <code>item.id</code>)</p>
</div>
        </div>
      
      
        <div class="code"><div class="wrapper">          keys = match.replace(<span class="hljs-string">'{'</span>, <span class="hljs-string">''</span>).replace(<span class="hljs-string">'}'</span>, <span class="hljs-string">''</span>).split(<span class="hljs-string">'.'</span>)
          value = entry
          _.each keys, <span class="hljs-function"><span class="hljs-params">(key)</span> -&gt;</span>
            value = value[key]

          <span class="hljs-keyword">if</span> value?
            entryUrl = entryUrl.replace match, value
          <span class="hljs-keyword">else</span>
            <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> Error <span class="hljs-string">"<span class="hljs-subst">#{name}</span> Model: Can't substitute <span class="hljs-subst">#{match}</span> in URL"</span>+
              <span class="hljs-string">"(entry has no value for <span class="hljs-subst">#{key}</span>)"</span>

        <span class="hljs-keyword">return</span> entryUrl

      <span class="hljs-keyword">if</span> _.isString config.detailUrl
        <span class="hljs-function"><span class="hljs-title">makeDetailUrl</span> = <span class="hljs-params">(entry)</span> -&gt;</span>
          config.parseUrlPattern(entry, config.detailUrl)
      <span class="hljs-keyword">else</span>
        <span class="hljs-function"><span class="hljs-title">makeDetailUrl</span> = <span class="hljs-params">(entry, listUrl=config.listUrl, baseUrl=config.baseUrl)</span> -&gt;</span>
          <span class="hljs-keyword">if</span> entry.id?
            <span class="hljs-string">"<span class="hljs-subst">#{baseUrl}</span><span class="hljs-subst">#{listUrl}</span>/<span class="hljs-subst">#{entry.id}</span>"</span>
          <span class="hljs-keyword">else</span>
            <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> Error <span class="hljs-string">"<span class="hljs-subst">#{name}</span> Model: Need entry ID to construct URL"</span>

      <span class="hljs-keyword">if</span> _.isFunction config.detailUrl
        config.<span class="hljs-function"><span class="hljs-title">getDetailUrl</span> = <span class="hljs-params">(entry, listUrl=config.listUrl, baseUrl=config.baseUrl)</span> -&gt;</span>
          config.detailUrl(entry, listUrl, baseUrl)
      <span class="hljs-keyword">else</span>
        config.getDetailUrl = makeDetailUrl


      IS_SINGLETON = !!config.is_singleton

      config.transformRequest ||= _.identity
      config.transformResponse ||= _.identity

      config.matchingCriteria ||= <span class="hljs-function"><span class="hljs-params">(data)</span> -&gt;</span> <span class="hljs-attribute">id</span>: +data.id
</div></div>
      
      </div>
    
      <div class="segment">
      
        <div class="comments ">
          <div class="wrapper"><h4 id="storage-implementation"><a href="#storage-implementation" class="anchor"></a>Storage Implementation</h4><p>Use key/value store to persist data.</p>
<p>Key schema: &quot;{collection name}.{all|data}&quot;</p>
<p>Use any implementation that has these methods:</p>
<ul>
<li><code>setItem(String key, value)</code></li>
<li><code>getItem(String key)</code></li>
<li><code>removeItem(String key)</code></li>
</ul>
<pre><code class="lang-coffeescript">myStorage =
  <span class="hljs-attribute">getItem</span>: <span class="hljs-function"><span class="hljs-params">(key)</span> -&gt;</span>
    value = <span class="hljs-built_in">window</span>.localStorage.getItem(key)
    value &amp;&amp; JSON.parse(value)
  <span class="hljs-attribute">setItem</span>: <span class="hljs-function"><span class="hljs-params">(key, value)</span> -&gt;</span>
    <span class="hljs-built_in">window</span>.localStorage.setItem(key, JSON.stringify(value))
  <span class="hljs-attribute">removeItem</span>: <span class="hljs-function"><span class="hljs-params">(key)</span> -&gt;</span>
    <span class="hljs-built_in">window</span>.localStorage.removeItem(key)

Collection.<span class="hljs-keyword">new</span> <span class="hljs-string">'People'</span>, {<span class="hljs-attribute">storage</span>: myStorage} <span class="hljs-comment"># uses localStorage now</span>
</code></pre>
</div>
        </div>
      
      
        <div class="code"><div class="wrapper">      store = <span class="hljs-keyword">do</span><span class="hljs-function"> -&gt;</span>
        _store = {}
        impl = config.storage <span class="hljs-keyword">or</span> {}

        _.each [<span class="hljs-string">'setItem'</span>, <span class="hljs-string">'getItem'</span>, <span class="hljs-string">'removeItem'</span>], <span class="hljs-function"><span class="hljs-params">(method)</span> -&gt;</span>
          _store[method] = <span class="hljs-keyword">if</span> _.isFunction impl[method]
            impl[method]
          <span class="hljs-keyword">else</span> angular.noop

        _store
</div></div>
      
      </div>
    
      <div class="segment">
      
        <div class="comments doc-section doc-section-private">
          <div class="wrapper"><p><span class='doc-section-header'>Private</span></p>
<h3 id="in-memory-data"><a href="#in-memory-data" class="anchor"></a>In Memory Data</h3><p>The Single Source of Truth</p>
</div>
        </div>
      
      
        <div class="code"><div class="wrapper">      Data = {}

      <span class="hljs-keyword">if</span> IS_SINGLETON <span class="hljs-comment"># Is single Model</span>
        _data =
          <span class="hljs-attribute">data</span>: store.getItem(<span class="hljs-string">"<span class="hljs-subst">#{name}</span>.data"</span>) || {}
</div></div>
      
      </div>
    
      <div class="segment">
      
        <div class="comments doc-section">
          <div class="wrapper"><p><span class='doc-section-header'>Method: <code>Get Data</code></span></p>
<p><strong>Returns an Object</strong><br/>(data)</p>
</div>
        </div>
      
      
        <div class="code"><div class="wrapper">        Data.<span class="hljs-function"><span class="hljs-title">get</span> = -&gt;</span> _data.data
</div></div>
      
      </div>
    
      <div class="segment">
      
        <div class="comments doc-section">
          <div class="wrapper"><p><span class='doc-section-header'>Method: <code>Replace Singleton Data</code></span></p>
<p>Parameters:</p>
<ul>
<li><strong><code>data</code> must be an Object.</strong><br/>(New data)</li>
</ul>
<p><strong>Returns an Object</strong><br/>(The complete data representation)</p>
</div>
        </div>
      
      
        <div class="code"><div class="wrapper">        Data.<span class="hljs-function"><span class="hljs-title">replace</span> = <span class="hljs-params">(data)</span> -&gt;</span>
          _data.data = _.extend(_data.data, data)
          store.setItem(<span class="hljs-string">"<span class="hljs-subst">#{name}</span>.data"</span>, _data.data)
          <span class="hljs-keyword">return</span> _data.data

      <span class="hljs-keyword">else</span> <span class="hljs-comment"># is Model[]</span>
        _data =
          <span class="hljs-attribute">all</span>: store.getItem(<span class="hljs-string">"<span class="hljs-subst">#{name}</span>.all"</span>) || []
</div></div>
      
      </div>
    
      <div class="segment">
      
        <div class="comments doc-section">
          <div class="wrapper"><p><span class='doc-section-header'>Method: <code>Get Data</code></span></p>
<p><strong>Returns an Array</strong><br/>(data)</p>
</div>
        </div>
      
      
        <div class="code"><div class="wrapper">        Data.<span class="hljs-function"><span class="hljs-title">get</span> = -&gt;</span> _data.all
</div></div>
      
      </div>
    
      <div class="segment">
      
        <div class="comments doc-section">
          <div class="wrapper"><p><span class='doc-section-header'>Method: <code>Replace Complete Collection Data</code></span></p>
<p>Parameters:</p>
<ul>
<li><strong><code>data</code> must be an Array.</strong><br/>(New data)</li>
</ul>
<p><strong>Returns an Object</strong><br/>(The complete data representation)</p>
</div>
        </div>
      
      
        <div class="code"><div class="wrapper">        Data.<span class="hljs-function"><span class="hljs-title">replace</span> = <span class="hljs-params">(data)</span> -&gt;</span>
          _data.all.splice(<span class="hljs-number">0</span>, data.length)
          [].push.apply(_data.all, data)
          store.setItem(<span class="hljs-string">"<span class="hljs-subst">#{name}</span>.all"</span>, _data.all)
          <span class="hljs-keyword">return</span> _data.all
</div></div>
      
      </div>
    
      <div class="segment">
      
        <div class="comments doc-section">
          <div class="wrapper"><p><span class='doc-section-header'>Method: <code>Update Single Entry from Collection</code></span></p>
<p>This will also add an entry if no existing one matches
  the criteria</p>
<p>Parameters:</p>
<ul>
<li><strong><code>data</code> must be an Object.</strong><br/>(New data)</li>
<li><strong><code>criteria</code> must be an Object.</strong><br/>(Used to find entry)</li>
</ul>
<p><strong>Returns an Object</strong><br/>(The updated entry)</p>
</div>
        </div>
      
      
        <div class="code"><div class="wrapper">        Data.<span class="hljs-function"><span class="hljs-title">updateEntry</span> = <span class="hljs-params">(data, criteria)</span> -&gt;</span>
          hit = _.findWhere(_data.all, criteria)
          <span class="hljs-keyword">if</span> hit?</div></div>
      
      </div>
    
      <div class="segment">
      
        <div class="comments ">
          <div class="wrapper"><p>update existing entry</p>
</div>
        </div>
      
      
        <div class="code"><div class="wrapper">            hit = _.extend(hit, data)
          <span class="hljs-keyword">else</span></div></div>
      
      </div>
    
      <div class="segment">
      
        <div class="comments ">
          <div class="wrapper"><p>add new entry (on top of list)</p>
</div>
        </div>
      
      
        <div class="code"><div class="wrapper">            _data.all.unshift(data)

          store.setItem(<span class="hljs-string">"<span class="hljs-subst">#{name}</span>.all"</span>, _data.all)

          <span class="hljs-keyword">return</span> <span class="hljs-keyword">if</span> hit? <span class="hljs-keyword">then</span> hit <span class="hljs-keyword">else</span> data
</div></div>
      
      </div>
    
      <div class="segment">
      
        <div class="comments doc-section">
          <div class="wrapper"><p><span class='doc-section-header'>Method: <code>Remove Single Entry from Collection</code></span></p>
<p>Parameters:</p>
<ul>
<li><strong><code>criteria</code> must be an Object.</strong><br/>(Used to find entry)</li>
</ul>
<p><strong>Returns a Bool</strong><br/>(Whether removal was)</p>
</div>
        </div>
      
      
        <div class="code"><div class="wrapper">        Data.<span class="hljs-function"><span class="hljs-title">removeEntry</span> = <span class="hljs-params">(criteria)</span> -&gt;</span>
          hit = _.findWhere(_data.all, criteria)
          <span class="hljs-keyword">if</span> hit?
            _data.all.splice _data.all.indexOf(hit), <span class="hljs-number">1</span>
            store.removeItem(<span class="hljs-string">"<span class="hljs-subst">#{name}</span>.all"</span>, _data.all)
          <span class="hljs-keyword">return</span> hit?

      config.Data = <span class="hljs-built_in">exports</span>.Data = Data
</div></div>
      
      </div>
    
      <div class="segment">
      
        <div class="comments ">
          <div class="wrapper"><h3 id="http-requests-and-stuff"><a href="#http-requests-and-stuff" class="anchor"></a>HTTP Requests and Stuff</h3></div>
        </div>
      
      
      </div>
    
      <div class="segment">
      
        <div class="comments doc-section">
          <div class="wrapper"><p><span class='doc-section-header'>Method: <code>Retrieve List</code></span></p>
<p>Gotta catch &#39;em all!</p>
<p>Parameters:</p>
<ul>
<li><strong><code>options</code> is optional and must be an Object.</strong><br/>(HTTP options)</li>
</ul>
<p><strong>Returns a Promise</strong><br/>(HTTP data)</p>
</div>
        </div>
      
      
        <div class="code"><div class="wrapper">      <span class="hljs-built_in">exports</span>.<span class="hljs-function"><span class="hljs-title">fetchAll</span> = <span class="hljs-params">(options={})</span> -&gt;</span>
        $http.get(<span class="hljs-string">"<span class="hljs-subst">#{config.baseUrl}</span><span class="hljs-subst">#{config.url}</span>"</span>, options)
        .<span class="hljs-keyword">then</span> <span class="hljs-function"><span class="hljs-params">(response)</span> -&gt;</span>
          <span class="hljs-keyword">unless</span> _.isArray(response.data)
            <span class="hljs-built_in">console</span>.warn <span class="hljs-string">"<span class="hljs-subst">#{name}</span> Model"</span>, <span class="hljs-string">"API Respsonse was"</span>, response.data
            <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> Error <span class="hljs-string">"<span class="hljs-subst">#{name}</span> Model: Expected array, got <span class="hljs-subst">#{<span class="hljs-keyword">typeof</span> response.data}</span>"</span>

          response.data = config.transformResponse(response.data, <span class="hljs-string">'array'</span>)
</div></div>
      
      </div>
    
      <div class="segment">
      
        <div class="comments ">
          <div class="wrapper"><p>replace array items with new data</p>
</div>
        </div>
      
      
        <div class="code"><div class="wrapper">          response.data = Data.replace(response.data)

          <span class="hljs-keyword">return</span> $q.<span class="hljs-keyword">when</span>(response)
</div></div>
      
      </div>
    
      <div class="segment">
      
        <div class="comments doc-section">
          <div class="wrapper"><p><span class='doc-section-header'>Method: <code>Retrieve Singleton</code></span></p>
<p>Parameters:</p>
<ul>
<li><strong><code>options</code> is optional and must be an Object.</strong><br/>(HTTP options)</li>
</ul>
<p><strong>Returns a Promise</strong><br/>(HTTP data)</p>
</div>
        </div>
      
      
        <div class="code"><div class="wrapper">      <span class="hljs-built_in">exports</span>.<span class="hljs-function"><span class="hljs-title">fetch</span> = <span class="hljs-params">(options={})</span> -&gt;</span>
        $http.get(<span class="hljs-string">"<span class="hljs-subst">#{config.baseUrl}</span><span class="hljs-subst">#{config.url}</span>"</span>, options)
        .<span class="hljs-keyword">then</span> <span class="hljs-function"><span class="hljs-params">(response)</span> -&gt;</span>
          <span class="hljs-keyword">unless</span> _.isObject(response.data)
            <span class="hljs-built_in">console</span>.warn <span class="hljs-string">"<span class="hljs-subst">#{name}</span> Model"</span>, <span class="hljs-string">"API Respsonse was"</span>, response.data
            <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> Error <span class="hljs-string">"<span class="hljs-subst">#{name}</span> Model: Expected object, got <span class="hljs-subst">#{<span class="hljs-keyword">typeof</span> response.data}</span>"</span>

          response.data = config.transformResponse(response.data, <span class="hljs-string">'one'</span>)
          response.data = Data.replace(response.data)
          <span class="hljs-keyword">return</span> $q.<span class="hljs-keyword">when</span>(response)
</div></div>
      
      </div>
    
      <div class="segment">
      
        <div class="comments doc-section">
          <div class="wrapper"><p><span class='doc-section-header'>Method: <code>Retrieve One</code></span></p>
<p>This also updates the internal data collection, of course.</p>
<p>TODO: Customize ID query</p>
<p>Parameters:</p>
<ul>
<li><strong><code>id</code> must be a String.</strong><br/>(The ID of the element to fetch.)</li>
<li><strong><code>options</code> is optional and must be an Object.</strong><br/>(HTTP options)</li>
</ul>
<p><strong>Returns a Promise</strong><br/>(HTTP data)</p>
</div>
        </div>
      
      
        <div class="code"><div class="wrapper">      <span class="hljs-built_in">exports</span>.<span class="hljs-function"><span class="hljs-title">fetchOne</span> = <span class="hljs-params">(query, options={})</span> -&gt;</span>
        <span class="hljs-keyword">try</span>
          _url = config.getDetailUrl(query, config.listUrl, config.baseUrl)
        <span class="hljs-keyword">catch</span> e
          <span class="hljs-keyword">return</span> $q.reject e.message || e

        $http.get(_url, options)
        .<span class="hljs-keyword">then</span> <span class="hljs-function"><span class="hljs-params">(res)</span> -&gt;</span>
          <span class="hljs-keyword">unless</span> _.isObject(res.data)
            <span class="hljs-built_in">console</span>.warn <span class="hljs-string">"<span class="hljs-subst">#{name}</span> Model"</span>, <span class="hljs-string">"API Respsonse was"</span>, res.data
            <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> Error <span class="hljs-string">"Expected object, got <span class="hljs-subst">#{<span class="hljs-keyword">typeof</span> res.data}</span>"</span>

          res.data = config.transformResponse(res.data, <span class="hljs-string">'one'</span>)
          res.data = Data.updateEntry res.data, config.matchingCriteria(res.data)
          <span class="hljs-keyword">return</span> $q.<span class="hljs-keyword">when</span>(res)
</div></div>
      
      </div>
    
      <div class="segment">
      
        <div class="comments doc-section">
          <div class="wrapper"><p><span class='doc-section-header'>Method: <code>Destroy some Entry</code></span></p>
<p>TODO: Customize ID query</p>
<p>Parameters:</p>
<ul>
<li><strong><code>id</code> must be a String.</strong><br/>(The ID of the element to fetch.)</li>
<li><strong><code>options</code> is optional and must be an Object.</strong><br/>(HTTP options)</li>
</ul>
<p><strong>Returns a Promise</strong><br/>(Whether destruction was successful)<br/><strong>and</strong> <strong>Can throw an Error</strong><br/>(When Collection is singleton or no ID is given)</p>
</div>
        </div>
      
      
        <div class="code"><div class="wrapper">      <span class="hljs-built_in">exports</span>.<span class="hljs-function"><span class="hljs-title">destroy</span> = <span class="hljs-params">(query, options={})</span> -&gt;</span>
        <span class="hljs-keyword">if</span> IS_SINGLETON
          <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> Error <span class="hljs-string">"<span class="hljs-subst">#{name}</span> Model: Singleton doesn't have `destroy` method."</span>

        <span class="hljs-keyword">try</span>
          _url = config.getDetailUrl(query, config.listUrl, config.baseUrl)
        <span class="hljs-keyword">catch</span> e
          <span class="hljs-keyword">return</span> $q.reject e.message || e

        $http.<span class="hljs-keyword">delete</span>(_url, options)
        .<span class="hljs-keyword">then</span> <span class="hljs-function"><span class="hljs-params">({status, data})</span> -&gt;</span>
          data = config.transformResponse(data, <span class="hljs-string">'destroy'</span>)
          <span class="hljs-keyword">return</span> $q.<span class="hljs-keyword">when</span> Data.removeEntry data, config.matchingCriteria(data)
</div></div>
      
      </div>
    
      <div class="segment">
      
        <div class="comments doc-section">
          <div class="wrapper"><p><span class='doc-section-header'>Method: <code>Save an Entry</code></span></p>
<p>TODO: Customize ID query</p>
<p>Parameters:</p>
<ul>
<li><strong><code>entry</code> must be an Object.</strong><br/>(The entry to be saved.)</li>
<li><strong><code>options</code> is optional and must be an Object.</strong><br/>(HTTP options)</li>
</ul>
<p><strong>Returns a Promise</strong><br/>(Resolved with new entry or rejected with HTTP error)</p>
</div>
        </div>
      
      
        <div class="code"><div class="wrapper">      <span class="hljs-built_in">exports</span>.<span class="hljs-function"><span class="hljs-title">save</span> = <span class="hljs-params">(entry, options={})</span> -&gt;</span>
        <span class="hljs-keyword">if</span> IS_SINGLETON
          _url = <span class="hljs-string">"<span class="hljs-subst">#{config.baseUrl}</span><span class="hljs-subst">#{config.listUrl}</span>"</span>
        <span class="hljs-keyword">else</span>
          <span class="hljs-keyword">try</span>
            _url = config.getDetailUrl(entry, config.listUrl, config.baseUrl)
          <span class="hljs-keyword">catch</span> e
            <span class="hljs-keyword">return</span> $q.reject e.message || e

        <span class="hljs-keyword">return</span> $http.post(_url, JSON.stringify(entry), options)
        .<span class="hljs-keyword">then</span> <span class="hljs-function"><span class="hljs-params">({status, data})</span> -&gt;</span>
          data = config.transformResponse(data, <span class="hljs-string">'save'</span>)

          <span class="hljs-keyword">if</span> IS_SINGLETON
            <span class="hljs-keyword">return</span> $q.<span class="hljs-keyword">when</span> Data.replace(data)
          <span class="hljs-keyword">else</span>
            <span class="hljs-keyword">return</span> $q.<span class="hljs-keyword">when</span> Data.updateEntry data, config.matchingCriteria(data)
</div></div>
      
      </div>
    
      <div class="segment">
      
        <div class="comments doc-section">
          <div class="wrapper"><p><span class='doc-section-header'>Method: <code>Create an Entry</code></span></p>
<p>Similar to save, but has no ID initially.</p>
<p>Parameters:</p>
<ul>
<li><strong><code>entry</code> must be an Object.</strong><br/>(Entry data)</li>
<li><strong><code>options</code> is optional and must be an Object.</strong><br/>(HTTP options)</li>
</ul>
<p><strong>Returns a Promise</strong><br/>(Resolves with new entry data or rejects with HTTP error)<br/><strong>and</strong> <strong>Can throw an Error</strong><br/>(When Collection is singleton)</p>
</div>
        </div>
      
      
        <div class="code"><div class="wrapper">      <span class="hljs-built_in">exports</span>.<span class="hljs-function"><span class="hljs-title">create</span> = <span class="hljs-params">(entry, options={})</span> -&gt;</span>
        <span class="hljs-keyword">if</span> IS_SINGLETON
          <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> Error <span class="hljs-string">"<span class="hljs-subst">#{name}</span> Model: Singleton doesn't have `destroy` method."</span>

        <span class="hljs-keyword">return</span> $http.post(<span class="hljs-string">"<span class="hljs-subst">#{config.baseUrl}</span><span class="hljs-subst">#{config.listUrl}</span>"</span>, entry, options)
        .<span class="hljs-keyword">then</span> <span class="hljs-function"><span class="hljs-params">({status, data})</span> -&gt;</span>
          <span class="hljs-keyword">return</span> $q.<span class="hljs-keyword">when</span> Data.updateEntry data, config.matchingCriteria(data)
</div></div>
      
      </div>
    
      <div class="segment">
      
        <div class="comments ">
          <div class="wrapper"><hr>
</div>
        </div>
      
      
      </div>
    
      <div class="segment">
      
        <div class="comments ">
          <div class="wrapper"><h3 id="generic-getters"><a href="#generic-getters" class="anchor"></a>Generic Getters</h3></div>
        </div>
      
      
      </div>
    
      <div class="segment">
      
        <div class="comments doc-section">
          <div class="wrapper"><p><span class='doc-section-header'>Method: <code>Get Collection</code></span></p>
<p>Parameters:</p>
<ul>
<li><strong><code>options</code> is optional and must be an Object.</strong><br/>(HTTP options)</li>
</ul>
<p><strong>Returns an Object</strong><br/>(Immediate Return Data (see above))</p>
</div>
        </div>
      
      
        <div class="code"><div class="wrapper">      <span class="hljs-built_in">exports</span>.<span class="hljs-function"><span class="hljs-title">all</span> = <span class="hljs-params">(options)</span> -&gt;</span>
        local =
          <span class="hljs-attribute">$loading</span>: <span class="hljs-literal">true</span>

        <span class="hljs-keyword">if</span> IS_SINGLETON
          local.$promise = <span class="hljs-built_in">exports</span>.fetch(options)
          local.$promise.<span class="hljs-keyword">then</span><span class="hljs-function"> -&gt;</span>
            local.$loading = <span class="hljs-literal">false</span>
            local.$resolved = <span class="hljs-literal">true</span>
          local.data = _data.data
        <span class="hljs-keyword">else</span>
          local.$promise = <span class="hljs-built_in">exports</span>.fetchAll(options)
          local.$promise.<span class="hljs-keyword">then</span><span class="hljs-function"> -&gt;</span>
            local.$loading = <span class="hljs-literal">false</span>
            local.$resolved = <span class="hljs-literal">true</span>
          local.all = _data.all

        <span class="hljs-keyword">return</span> local
</div></div>
      
      </div>
    
      <div class="segment">
      
        <div class="comments doc-section">
          <div class="wrapper"><p><span class='doc-section-header'>Method: <code>Query Collection</code></span></p>
<p>Parameters:</p>
<ul>
<li><strong><code>query</code> must be an Object.</strong><br/>(Query the collection á la <code>{name: &quot;Jim&quot;}</code>)</li>
</ul>
<p><strong>Returns an Array</strong><br/>(Objects matching the query.)</p>
</div>
        </div>
      
      
        <div class="code"><div class="wrapper">      <span class="hljs-built_in">exports</span>.<span class="hljs-function"><span class="hljs-title">where</span> = <span class="hljs-params">(query)</span> -&gt;</span>
        _.where(_data.all, query)
</div></div>
      
      </div>
    
      <div class="segment">
      
        <div class="comments doc-section">
          <div class="wrapper"><p><span class='doc-section-header'>Method: <code>Get Single Collection Entry</code></span></p>
<p>TODO: Customize ID query</p>
<p>Parameters:</p>
<ul>
<li><strong><code>query</code> must be an Object.</strong><br/>(The query that will be used in <code>matchingCriteria</code>)</li>
<li><strong><code>options</code> is optional and must be an Object.</strong><br/>(HTTP options)</li>
</ul>
<p><strong>Returns an Object</strong><br/>(Immediate Return Data (see above))<br/><strong>and</strong> <strong>Can throw an Error</strong><br/>(When Collection is singleton)</p>
</div>
        </div>
      
      
        <div class="code"><div class="wrapper">      <span class="hljs-built_in">exports</span>.<span class="hljs-function"><span class="hljs-title">get</span> = <span class="hljs-params">(query, options)</span> -&gt;</span>
        <span class="hljs-keyword">if</span> IS_SINGLETON
          <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> Error <span class="hljs-string">"<span class="hljs-subst">#{name}</span> Model: Singleton doesn't have `get` method."</span>

        local =
          <span class="hljs-attribute">$loading</span>: <span class="hljs-literal">true</span>

        local.data = _.findWhere _data.all, config.matchingCriteria(query)
        local.$promise = <span class="hljs-built_in">exports</span>.fetchOne(query, options)
        .<span class="hljs-keyword">then</span> <span class="hljs-function"><span class="hljs-params">(response)</span> -&gt;</span>
          local.data = response.data
          local.$loading = <span class="hljs-literal">false</span>
          local.$resolved = <span class="hljs-literal">true</span>
          $q.<span class="hljs-keyword">when</span>(response)

        <span class="hljs-keyword">return</span> local
</div></div>
      
      </div>
    
      <div class="segment">
      
        <div class="comments ">
          <div class="wrapper"><h3 id="mixin-extras"><a href="#mixin-extras" class="anchor"></a>Mixin Extras</h3></div>
        </div>
      
      
        <div class="code"><div class="wrapper">      <span class="hljs-function"><span class="hljs-title">addExtraCall</span> = <span class="hljs-params">(key, val)</span> -&gt;</span>
        <span class="hljs-keyword">unless</span> val.url
          val.url = <span class="hljs-string">"<span class="hljs-subst">#{config.baseUrl}</span><span class="hljs-subst">#{config.listUrl}</span>/<span class="hljs-subst">#{key}</span>"</span>

        <span class="hljs-keyword">if</span> _.isFunction val.onSuccess
          success = _.bind(val.onSuccess, config)
          <span class="hljs-keyword">delete</span> val.onSuccess
        <span class="hljs-keyword">if</span> _.isFunction val.onFail
          fail = _.bind(val.onFail, config)
          <span class="hljs-keyword">delete</span> val.onFail
</div></div>
      
      </div>
    
      <div class="segment">
      
        <div class="comments doc-section">
          <div class="wrapper"><p>TODO: Add data storage options</p>
</div>
        </div>
      
      
        <div class="code"><div class="wrapper">        <span class="hljs-built_in">exports</span>[key] = <span class="hljs-function"><span class="hljs-params">(data, options={})</span> -&gt;</span>
          <span class="hljs-keyword">if</span> !options.url
            <span class="hljs-keyword">if</span> _.isFunction(val.url)
              options.url = val.url(data, config.listUrl, config.detailUrl)
            <span class="hljs-keyword">else</span>
              options.url = config.parseUrlPattern(data, val.url)

          call = $http _.extend(val, options), data
          call.<span class="hljs-keyword">then</span>(success) <span class="hljs-keyword">if</span> success?
          call.<span class="hljs-keyword">then</span>(<span class="hljs-literal">null</span>, fail) <span class="hljs-keyword">if</span> fail?
          <span class="hljs-keyword">return</span> call

      _.each extras, <span class="hljs-function"><span class="hljs-params">(val, key)</span> -&gt;</span></div></div>
      
      </div>
    
      <div class="segment">
      
        <div class="comments ">
          <div class="wrapper"><p>Custom methods</p>
</div>
        </div>
      
      
        <div class="code"><div class="wrapper">        <span class="hljs-keyword">if</span> _.isFunction(val)
          <span class="hljs-built_in">exports</span>[key] = _.bind(val, config)</div></div>
      
      </div>
    
      <div class="segment">
      
        <div class="comments ">
          <div class="wrapper"><p>Custom HTTP Call</p>
</div>
        </div>
      
      
        <div class="code"><div class="wrapper">        <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> _.isObject(val)
          addExtraCall key, val

</div></div>
      
      </div>
    
      <div class="segment">
      
        <div class="comments ">
          <div class="wrapper"><hr>
</div>
        </div>
      
      
        <div class="code"><div class="wrapper">      <span class="hljs-built_in">exports</span>

    <span class="hljs-keyword">return</span> <span class="hljs-attribute">new</span>: constructor

  <span class="hljs-keyword">return</span>


.factory <span class="hljs-string">"CollectionLocalStorage"</span>,<span class="hljs-function"> -&gt;</span></div></div>
      
      </div>
    
      <div class="segment">
      
        <div class="comments ">
          <div class="wrapper"><h2 id="storage-wrapper-for-localstorage"><a href="#storage-wrapper-for-localstorage" class="anchor"></a>Storage Wrapper for LocalStorage</h2></div>
        </div>
      
      
        <div class="code"><div class="wrapper">  <span class="hljs-keyword">return</span> <span class="hljs-keyword">unless</span> <span class="hljs-built_in">window</span>.localStorage?

  <span class="hljs-keyword">return</span> {</div></div>
      
      </div>
    
      <div class="segment">
      
        <div class="comments doc-section">
          <div class="wrapper"><h3 id="get-item"><a href="#get-item" class="anchor"></a>Get Item</h3><p>Parameters:</p>
<ul>
<li><strong><code>key</code> must be a String.</strong></li>
</ul>
<p><strong>Returns an Any</strong></p>
</div>
        </div>
      
      
        <div class="code"><div class="wrapper">    <span class="hljs-attribute">getItem</span>: <span class="hljs-function"><span class="hljs-params">(key)</span> -&gt;</span>
      value = <span class="hljs-built_in">window</span>.localStorage.getItem(key)
      value &amp;&amp; JSON.parse(value)
</div></div>
      
      </div>
    
      <div class="segment">
      
        <div class="comments doc-section">
          <div class="wrapper"><h3 id="set-item"><a href="#set-item" class="anchor"></a>Set Item</h3><p>Parameters:</p>
<ul>
<li><strong><code>key</code> must be a String.</strong></li>
<li><strong><code>value</code> must be an Any.</strong></li>
</ul>
<p><strong>Returns an Any</strong></p>
</div>
        </div>
      
      
        <div class="code"><div class="wrapper">    <span class="hljs-attribute">setItem</span>: <span class="hljs-function"><span class="hljs-params">(key, value)</span> -&gt;</span>
      <span class="hljs-built_in">window</span>.localStorage.setItem(key, JSON.stringify(value))
</div></div>
      
      </div>
    
      <div class="segment">
      
        <div class="comments doc-section">
          <div class="wrapper"><h3 id="remove-item"><a href="#remove-item" class="anchor"></a>Remove Item</h3><p>Parameters:</p>
<ul>
<li><strong><code>key</code> must be a String.</strong></li>
</ul>
</div>
        </div>
      
      
        <div class="code"><div class="wrapper">    <span class="hljs-attribute">removeItem</span>: <span class="hljs-function"><span class="hljs-params">(key)</span> -&gt;</span>
      <span class="hljs-built_in">window</span>.localStorage.removeItem(key)
  }
</div></div>
      
      </div>
    
    </div>
  </div>

  <script src="../toc.js"></script>
  <script src="../assets/libs.js"></script>
  <script src="../assets/behavior.js"></script>
</body>
</html>