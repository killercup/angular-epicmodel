/*!
* angular-epicmodel
*
* @author [Pascal Hertleif](https://github.com/killercup)
* @version 0.4.3
* @license MIT
*/
(function(){angular.module("EpicModel",[]).provider("Collection",function(){var e;e={baseUrl:""},this.setBaseUrl=function(t){if(null==t&&(t=""),null==t)throw new Error("No URL given.");return e.baseUrl=t},this.$get=["$q","$http",function(t,r){var n;return n=function(n,a,l){var o,u,i,s,c,d,f;if(null==a&&(a={}),null==l&&(l={}),s={},null==n)throw new Error("No name given!");return s.config=function(e){return a[e]},a.url||(a.url="/"+n.toLowerCase()),a.baseUrl||(a.baseUrl=e.baseUrl),a.listUrl||(a.listUrl=a.url),a.parseUrlPattern=function(e,t){var r,a;return a=/\{([\w_.]*?)\}/g,r=t,_.each(t.match(a),function(t){var a,l;if(a=t.replace("{","").replace("}","").split("."),l=e,_.each(a,function(e){return l=l[e]}),null!=l)return r=r.replace(t,l);throw new Error(""+n+" Model: Can't substitute "+t+" in URL"+("(entry has no value for "+key+")"))}),r},c=_.isString(a.detailUrl)?function(e){return a.parseUrlPattern(e,""+a.baseUrl+a.detailUrl)}:function(e,t,r){if(null==t&&(t=a.listUrl),null==r&&(r=a.baseUrl),null!=e.id)return""+r+t+"/"+e.id;throw new Error(""+n+" Model: Need entry ID to construct URL")},a.getDetailUrl=_.isFunction(a.detailUrl)?function(e,t,r){return null==t&&(t=a.listUrl),null==r&&(r=a.baseUrl),a.detailUrl(e,t,r)}:c,u=!!a.is_singleton,a.transformRequest||(a.transformRequest=_.identity),a.transformResponse||(a.transformResponse=_.identity),a.matchingCriteria||(a.matchingCriteria=function(e){return{id:+e.id}}),d=function(){var e,t;return t={},e=a.storage||{},_.each(["setItem","getItem","removeItem"],function(r){return t[r]=_.isFunction(e[r])?e[r]:angular.noop}),t}(),o={},u?(f={data:d.getItem(""+n+".data")||{}},o.get=function(){return f.data},o.replace=function(e){return f.data=_.extend(f.data,e),d.setItem(""+n+".data",f.data),f.data}):(f={all:d.getItem(""+n+".all")||[]},o.get=function(){return f.all},o.replace=function(e){return f.all.splice(0,e.length),[].push.apply(f.all,e),d.setItem(""+n+".all",f.all),f.all},o.updateEntry=function(e,t){var r;return r=_.findWhere(f.all,t),null!=r?r=_.extend(r,e):f.all.unshift(e),d.setItem(""+n+".all",f.all),null!=r?r:e},o.removeEntry=function(e){var t;return t=_.findWhere(f.all,e),null!=t&&(f.all.splice(f.all.indexOf(t),1),d.removeItem(""+n+".all",f.all)),null!=t}),a.Data=s.Data=o,s.fetchAll=function(e){var l;return null==e&&(e={}),l=_.defaults(e,{method:"GET",url:""+a.baseUrl+a.url}),r(l).then(function(e){if(!_.isArray(e.data))throw console.warn(""+n+" Model","API Respsonse was",e.data),new Error(""+n+" Model: Expected array, got "+typeof e.data);return e.data=a.transformResponse(e.data,"array"),e.data=o.replace(e.data),t.when(e)})},s.fetch=function(e){var l;return null==e&&(e={}),l=_.defaults(e,{method:"GET",url:""+a.baseUrl+a.url}),r(l).then(function(e){if(!_.isObject(e.data))throw console.warn(""+n+" Model","API Respsonse was",e.data),new Error(""+n+" Model: Expected object, got "+typeof e.data);return e.data=a.transformResponse(e.data,"one"),e.data=o.replace(e.data),t.when(e)})},s.fetchOne=function(e,l){var u,i,s;null==l&&(l={});try{s=a.getDetailUrl(e,a.listUrl,a.baseUrl)}catch(c){return u=c,t.reject(u.message||u)}return i=_.defaults(l,{method:"GET",url:s}),r(i).then(function(e){if(!_.isObject(e.data))throw console.warn(""+n+" Model","API Respsonse was",e.data),new Error("Expected object, got "+typeof e.data);return e.data=a.transformResponse(e.data,"one"),e.data=o.updateEntry(e.data,a.matchingCriteria(e.data)),t.when(e)})},s.destroy=function(e,l){var i,s,c;if(null==l&&(l={}),u)throw new Error(""+n+" Model: Singleton doesn't have `destroy` method.");try{c=a.getDetailUrl(e,a.listUrl,a.baseUrl)}catch(d){return i=d,t.reject(i.message||i)}return s=_.defaults(l,{method:"DELETE",url:c}),r(s).then(function(e){var r,n;return n=e.status,r=e.data,r=a.transformResponse(r,"destroy"),t.when(o.removeEntry(a.matchingCriteria(r)))})},s.save=function(e,n){var l,i,s;if(null==n&&(n={}),u)s=""+a.baseUrl+a.listUrl;else try{s=a.getDetailUrl(e,a.listUrl,a.baseUrl)}catch(c){return l=c,t.reject(l.message||l)}return i=_.defaults(n,{method:"PUT",url:s,data:angular.toJson(e)}),r(i).then(function(e){var r,n;return n=e.status,r=e.data,r=a.transformResponse(r,"save"),t.when(u?o.replace(r):o.updateEntry(r,a.matchingCriteria(r)))})},s.create=function(e,l){var i;if(null==l&&(l={}),u)throw new Error(""+n+" Model: Singleton doesn't have `destroy` method.");return i=_.defaults(l,{method:"POST",url:""+a.baseUrl+a.listUrl,data:angular.toJson(e)}),r(i).then(function(e){var r,n;return n=e.status,r=e.data,t.when(o.updateEntry(r,a.matchingCriteria(r)))})},s.all=function(e){var r;return r={$loading:!0},u?(r.$promise=s.fetch(e),r.data=f.data):(r.$promise=s.fetchAll(e),r.all=f.all),r.$promise=r.$promise.then(function(e){return r.$loading=!1,r.$resolved=!0,t.when(e)}).then(null,function(e){return r.$error=e,r.$loading=!1,t.reject(e)}),r},s.where=function(e){return _.where(f.all,e)},s.get=function(e,r){var l;if(u)throw new Error(""+n+" Model: Singleton doesn't have `get` method.");return l={$loading:!0},l.data=_.findWhere(f.all,a.matchingCriteria(e)),l.$promise=s.fetchOne(e,r).then(function(e){return l.data=e.data,l.$loading=!1,l.$resolved=!0,t.when(e)}).then(null,function(e){return l.$error=e,l.$loading=!1,t.reject(e)}),l},i=function(e,t){var n,l;return t.url||(t.url=""+a.baseUrl+a.listUrl+"/"+e),_.isFunction(t.onSuccess)&&(l=_.bind(t.onSuccess,a),delete t.onSuccess),_.isFunction(t.onFail)&&(n=_.bind(t.onFail,a),delete t.onFail),s[e]=function(e,o){var u;return null==o&&(o={}),o.url||(o.url=_.isFunction(t.url)?t.url(e,a.listUrl,a.detailUrl):a.parseUrlPattern(e,""+a.baseUrl+t.url)),u=r(_.defaults(o,t),e),null!=l&&u.then(l),null!=n&&u.then(null,n),u}},_.each(l,function(e,t){return _.isFunction(e)?s[t]=_.bind(e,a):_.isObject(e)?i(t,e):void 0}),s},{"new":n}}]}).factory("CollectionLocalStorage",function(){return null!=window.localStorage?{getItem:function(e){var t;return t=window.localStorage.getItem(e),t&&JSON.parse(t)},setItem:function(e,t){return window.localStorage.setItem(e,angular.toJson(t))},removeItem:function(e){return window.localStorage.removeItem(e)}}:void 0})}).call(this);